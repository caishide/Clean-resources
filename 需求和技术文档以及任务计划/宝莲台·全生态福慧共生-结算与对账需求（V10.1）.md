# 宝莲台·全生态福慧共生（V10.1）— 结算与对账需求

## 0. 文档信息
- 版本：V1.0
- 日期：2025-12-16
- 目标读者：财务/研发/测试
- 依赖文档：
  - `docs/宝莲台 · 财务风控与 K 值算法详解.md`
  - `docs/宝莲台·全球合伙人分红制度手册.md`
  - `docs/宝莲台·通证化（Web3）启动筹备方案.md`
  - `docs/宝莲台·全生态福慧共生-数据字典与字段表（V10.1）.md`

## 1. 总体结算分层（瀑布流）
### 1.1 奖金类型与优先级
1) 销售类刚性奖金（Fixed Sales Bonus）
- 直推奖 20%（实时）
- 层碰奖 25%（实时）

2) 股东类刚性预留（Global Pool Reserve）
- 季度分红预留 4%（1% 消费商池 + 3% 领导人池）

3) 组织类弹性奖金（Variable Team Bonus，K 值仅作用于此）
- 对碰奖 10%（周结）
- 管理奖 10%~5%（周结）

### 1.2 激活、待处理与应计预留（已拍板）
- 激活口径：个人累计请购宝莲台 ≥ 1 台。
- 收款人未激活：奖金不入余额，进入“待处理”台账。
- 释放方式：**自动释放 + 异常人工**（收款人激活后自动释放；风控/冻结/争议进入人工）。
- 风控口径：直推/层碰等刚性奖金即使暂未发放，也要在当周先做“应计预留”，计入当周 FixedSales。

## 2. 关键事件与台账
### 2.1 事件：订单发货（PV 入账事件）
触发时点：订单从 pending → shipped。

必须产生的记账动作：
1) PV 记账（Placement PV）
- 将本订单 PV（数量×3000）沿安置链向上累加到每个上级的左/右区 PV。
- 必须写入 PV 台账（已拍板：pv_ledger，详见数据字典）。

2) 直推奖（实时）
- 计算：订单 PV × 20%
- 收款人：购买者的 Sponsor（推荐人）
- 若收款人已激活：写入 transactions（+）
- 若收款人未激活：写入 pending_bonuses（待处理）

3) 层碰奖（实时）
- 回溯：从购买者开始向上遍历所有安置上级（pos_id 链）
- 对每个上级 uplink：计算相对层级 level + 所属侧（L/R）
- 维护 user_level_hits：首次点亮 left/right；当两侧均点亮则触发层碰奖
- 若收款人已激活：transactions（+）
- 若收款人未激活：pending_bonuses

4) 莲子积分（实时 A/B）
- 自购（A）：购买者 +3000×数量
- 直推（B）：购买者 Sponsor +1500×数量
- 记入 user_assets + user_points_log

5) 活跃标记
- 更新用户 last_activity_date（用于季度分红活跃判定）

### 2.2 事件：每日签到（莲子 D）
- 触发：用户点击签到
- 规则：每天一次 +10
- 记入 user_assets + user_points_log（source=DAILY）

## 3. 周结算（对碰 + 管理 + K 值 + 周封顶）
> K 值算法详见：`docs/宝莲台 · 财务风控与 K 值算法详解.md`

### 3.1 周期与批次
- 周期：自然周（周一 00:00:00 至周日 23:59:59，具体可配置）
- 批次号：week_key（如 2025-W50）

### 3.2 周结算输入
- 本周全网新增 PV：本周内所有“订单发货 PV 入账”的 PV 总和。
- 本周刚性奖金（FixedSales，已拍板：含应计预留）：
  - 直推：本周已发金额 + 本周进入“待处理”的应计金额
  - 层碰：本周已发金额 + 本周进入“待处理”的应计金额
- 本周分红预留：本周总 PV × 4%（进入季度池）。

### 3.3 对碰奖（10%）理论计算
- 每个用户：
  - WeakPV = min(leftPV, rightPV)
  - PairCount = floor(WeakPV / 3000)
  - PairPotentialAmount = PairCount × 300

- PV 扣减口径：只扣减已发放部分。

### 3.4 管理奖（10%~5%）理论计算
- 基数：下级对碰奖收入
  - 推荐口径：以本周下级对碰“实发（已封顶且已乘 K）”为准。
  - 等价实现：先算下级对碰“封顶后理论”，再统一乘 K（保证对账一致即可）。
- 代数：1~3 代 10%，4~5 代 5%
- 归属：Sponsor 链（推荐树）

### 3.5 周封顶（仅对碰）
- 封顶仅作用于：对碰（管理奖不计入封顶）。
- 对每个用户：
  - CapAmount = 根据身份等级（初/中/高）
  - PairCappedPotential = min(PairPotentialAmount, CapAmount)
  - MatchingPotentialAmount 不做封顶（但会参与 K 值折算）。

> 你已确认：K 值的 Potential 在“应用周封顶后再汇总”。

### 3.6 K 值计算（瀑布流）
- TotalCap = WeekTotalPV × 70%
- GlobalReserve = WeekTotalPV × 4%
- FixedSales = 本周直推 + 本周层碰（已发 + 待处理应计预留）
- Remaining = TotalCap - GlobalReserve - FixedSales

- A（Potential）= Σ(每个用户 PairCappedPotential + MatchingPotentialAmount)
- K =
  - 1（Remaining ≥ A）
  - Remaining / A（Remaining < A）
  - 0（Remaining ≤ 0）

- 每个用户：
  - 对碰实发（PairPaid）= PairCappedPotential × K
  - 管理实发（MatchingPaid）= MatchingPotentialAmount × K

### 3.7 周结算输出（必须落库）
- weekly_settlements：保存 week_key、总 PV、FixedSales、GlobalReserve、A、K、状态
- weekly_settlement_user_summaries：保存每用户本周：
  - leftPV/rightPV 初始/期末
  - 对碰次数、对碰理论/实发
  - 管理理论/实发
  - 对碰封顶额度/使用（仅对碰）
  - K
- transactions：对碰/管理的入账流水（remark 建议区分类型与批次）
- PV 扣减日志：仅扣减已发放对碰对应的 PV

### 3.8 莲子 TEAM（团队算力 C）（已拍板：随周结一次性产出）
- 按 Web3 方案：TEAM = WeakLegNewPV × 0.1。
- 产出频率：如果奖金（对碰/管理）按周结算，则 TEAM 莲子也按周结算批次一次性产出。
- 触发点：周结算 Finalize 时发放 TEAM 莲子，并写入 user_points_log（source=TEAM，reference=week_key）。
- WeakLegNewPV 口径：建议采用“本周弱区新增 PV”（需要在实现中落库为周统计字段，避免后续口径争议）。

## 4. 季度分红结算（1% 消费商池 + 3% 领导人池）
> 依据：`docs/宝莲台·全球合伙人分红制度手册.md`

### 4.1 结算区间与发放日
- 建议结算区间：自然季度 Q1/Q2/Q3/Q4
- 建议发放日：1/4/7/10 月 15 日发放上一季度

### 4.2 消费商池（1%）
- Pool = QuarterTotalPV × 1%
- Eligible：个人累计请购 ≥ 3 台
- Shares：个人累计请购台数
- Active（当季任一满足）：直推 1 单 或 自购 1 单
- TotalShares = Σ(Shares)（仅统计 Eligible 且 Active）
- UnitValue = Pool / TotalShares
- 用户分红 = Shares × UnitValue

- 不活跃处理：当季不参与分配；该季 1% 池未分配部分留存于池中/滚入下一季（按手册）；份数继续累计。

### 4.3 领导人池（3%）
- Pool = QuarterTotalPV × 3%
- 当季参与门槛：QuarterlyWeakPV ≥ 10,000
- 职级判定：
  - 历史累计小区 PV 达标
  - 架构达标仅看 Sponsor 树
- 当季积分：Score = QuarterlyWeakPV × RankMultiplier
- TotalScore = Σ(Score)
- UnitValue = Pool / TotalScore
- 用户分红 = Score × UnitValue

### 4.4 季度输出与对账
- quarterly_settlements：quarter_key、pool_stockist、pool_leader、total_shares、total_score、unit_value 等
- dividend_logs：按用户记录本季结果（含状态：已发/当季未达标不发）
- transactions：分红入账（remark 区分 stockist_dividend / leader_dividend）

## 5. 对账与可追溯要求（强制）
### 5.1 追溯链
必须支持从任意一笔交易流水反查：
- 对应结算批次（周/季度）
- 对应订单（若为直推/层碰/自购莲子）
- 对应 PV 台账记录（产生 PV 的来源与路径）

### 5.2 可复算与幂等
- 周结算/季度结算必须可复算（至少在“预演”层面可复算）。
- 执行（Finalize）必须幂等：同一批次不允许重复入账。

### 5.3 导出
- 周结算导出：汇总 + 用户明细 + 异常列表
- 季度结算导出：1%/3% 明细 + 未达标清单
- 待处理奖金导出：余额总额 + 明细

## 6. 退单/退款与冲正（已拍板）
### 6.1 原则
- 发货前取消：不产生 PV/奖金/莲子，无需冲正。
- 发货后退款：必须可追溯、可冲正（负向流水）；余额不足允许为负。

### 6.2 冲正范围（最小闭环）
- PV：反向扣减沿安置链累加的 PV（建议使用结构化 PV 台账，支持按订单回滚）。
- 直推/层碰：按“订单来源”生成负向流水冲正。
- 莲子 A/B：按订单 reference 生成负向积分流水冲正。
- 莲子 TEAM：随周结批次产出；若需冲正，走“调整批次（Adjustment Batch）”产生差额调整流水。

> 说明：如果要做到“严格复原历史周结结果”，需要做结算批次重算与差额调整（实现复杂度高）。

### 6.3 冲正时机
- 若退款发生在订单所属自然周结算 Finalize 之前：允许自动冲正，并在周结算里自然反映。
- 若退款发生在该周已 Finalize 之后：进入异常工单，生成“调整批次（Adjustment Batch）”，并产生差额冲正流水（不做全网回滚重算）。

### 6.4 余额与提现限制
- 冲正方式：从钱包扣回（transactions 负向流水）。
- 余额不足：允许为负。
- 若已提现导致余额为负：后续收益优先抵扣；在余额恢复前限制继续提现/转账。

## 7. 验收用例（结算侧）
1) K 值熔断：构造 Remaining < A，验证 K<1 且可变奖金按比例折算。
2) 周封顶：构造用户理论对碰>封顶，验证对碰先封顶后参与 K（管理不计入封顶）。
3) PV 扣减：验证仅扣减已发放对碰对应 PV。
4) 季度分红：
   - 1%：按 Shares 分配；不活跃当季不发放（池留存）
   - 3%：按 Score=QuarterlyWeakPV×W 分配；QuarterlyWeakPV<10000 不参与
5) 莲子：PURCHASE/DIRECT/TEAM/DAILY 四类流水均可追溯，且每日签到不可重复。
6) 退款冲正：发货后退款能冲正直推/层碰/莲子，且可产生负余额并限制提现。
