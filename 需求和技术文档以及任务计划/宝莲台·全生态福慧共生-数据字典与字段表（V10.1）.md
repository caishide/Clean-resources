# 宝莲台·全生态福慧共生（V10.1）— 数据字典与字段表

## 0. 文档信息
- 版本：V1.0
- 日期：2025-12-16
- 适用：数据库（MySQL）与审计台账设计
- 参考：
  - `Files/install/database.sql`（现有表结构）
  - `docs/宝莲台 · 财务风控与 K 值算法详解.md`
  - `docs/宝莲台·全球合伙人分红制度手册.md`
  - `docs/宝莲台·通证化（Web3）启动筹备方案.md`

## 1. 现有核心表（摘取与本制度相关字段）

## 1.1 users（用户表）
来源：`Files/install/database.sql`。

| 字段 | 类型 | 说明 |
|---|---|---|
| id | bigint unsigned | 用户 ID |
| ref_by | int | 推荐人（Sponsor）ID |
| pos_id | int | 安置人（Placement 上级）ID |
| position | int | 安置位置：1=Left，2=Right（0=未安置） |
| plan_id | int | 现有系统“计划/套餐”订阅（与宝莲台请购是两条线） |
| total_invest | decimal(28,8) | 历史投资额（现有字段） |
| username | varchar(40) | 用户名 |
| email | varchar(40) | 邮箱 |
| mobile | varchar(40) | 手机 |
| balance | decimal(28,8) | 余额 |
| status | tinyint(1) | 0=禁用，1=启用 |
| ev/sv/kv | tinyint | 邮箱/短信/KYC 状态 |
| created_at/updated_at | timestamp | 时间戳 |

### V10.1 需要新增/扩展（建议）
| 字段 | 类型 | 默认 | 说明 |
|---|---:|---:|---|
| rank_level | tinyint | 0 | 身份等级：0=未激活，1=初级，2=中级，3=高级（由个人请购台数自动升级） |
| personal_purchase_count | int | 0 | 个人累计请购宝莲台数量（发货入账才计入） |
| last_activity_date | date | null | 季度活跃判定：当季有直推订单或自购订单时更新 |
| leader_rank_code | varchar(20) | null | 领导人职级代码：liuli_xingzhe/huangjin_daoshi/manao_hufa/moni_dade/jingang_zunzhe（对应：琉璃行者/黄金导师/玛瑙护法/摩尼大德/金刚尊者） |
| leader_rank_multiplier | decimal(6,2) | 0 | 领导人分红系数（W）快照（季度结算时固化） |

> 备注：如果你希望与“计划/套餐（plan_id）”彻底解耦，可保持 plan_id 不动，只新增上述宝莲台相关字段。

## 1.2 user_extras（二元树左右区汇总）
| 字段 | 类型 | 说明 |
|---|---|---|
| user_id | int | 用户 ID |
| bv_left | decimal(16,8) | 左区业绩累计（V10.1 展示为 PV 左） |
| bv_right | decimal(16,8) | 右区业绩累计（V10.1 展示为 PV 右） |
| paid_left/paid_right | int | 现有系统统计字段（与本制度可选） |
| free_left/free_right | int | 现有系统统计字段（与本制度可选） |

## 1.3 bv_logs（PV/BV 变更日志：现有）
| 字段 | 类型 | 说明 |
|---|---|---|
| user_id | int | 被累计的上级用户 |
| position | int | 1=Left，2=Right |
| amount | decimal(16,8) | 变更值 |
| trx_type | varchar(50) | "+" 或 "-"（现有用法） |
| details | varchar(191) | 文本描述（现有） |
| created_at | timestamp | 时间 |

### V10.1 审计增强（已拍板：新建 pv_ledger）
已拍板：新建 `pv_ledger` 作为 V10.1 PV 台账（见 2.12），用于对账、退款冲正与按订单回滚。
`bv_logs` 保持现有用途用于兼容历史；如未来不建 pv_ledger 的备选方案见下方（未采用）。

#### 备选（未采用）：继续复用 bv_logs 的字段扩展建议（不新建 pv_ledger）
| 字段 | 类型 | 说明 |
|---|---|---|
| source_type | varchar(30) | order/weekly_settlement/adjustment |
| source_id | varchar(50) | orders.trx / week_key / adjustment_batches.batch_key |
| from_user_id | bigint null | PV 来源用户（下单者） |
| level | int null | 相对层级（可选，用于排查层碰/对碰争议） |
| week_key | varchar(20) null | PV 归属自然周（用于周结快照/对账） |
| adjustment_batch_id | bigint null | 调整批次（Finalize 后退款/纠错） |
| reversal_of_id | bigint null | 被冲正的 bv_logs.id |
| meta | json null | 扩展信息（可选） |

索引建议：
- INDEX(user_id, created_at)
- INDEX(source_type, source_id)
- INDEX(adjustment_batch_id)
- INDEX(reversal_of_id)

## 1.4 orders（订单表）
| 字段 | 类型 | 说明 |
|---|---|---|
| id | bigint unsigned | 订单 ID |
| user_id | int | 下单用户 |
| product_id | int | 商品 |
| quantity | int | 数量 |
| total_price | decimal(28,8) | 总价 |
| trx | varchar(40) | 交易号 |
| status | tinyint | 0=pending，1=shipped，2=canceled |
| created_at/updated_at | timestamp | 时间 |

## 1.5 products（商品表）
| 字段 | 类型 | 说明 |
|---|---|---|
| id | bigint unsigned | 商品 ID |
| price | decimal(28,8) | 单价 |
| bv | int | 业绩值（V10.1 作为 PV） |
| quantity | int | 库存 |
| status | tinyint(1) | 上下架 |

## 1.6 transactions（资金流水：现有）
来源：`Files/install/database.sql`。

| 字段 | 类型 | 说明 |
|---|---|---|
| id | bigint unsigned | 主键 |
| user_id | int unsigned | 收款/付款用户 |
| amount | decimal(28,8) | 金额（不含手续费） |
| charge | decimal(28,8) | 手续费（如有） |
| post_balance | decimal(28,8) | 变更后余额 |
| trx_type | varchar(40) | "+" or "-" |
| trx | varchar(40) | 流水号 |
| remark | varchar(40) | 类型标识（建议标准化） |
| details | varchar(255) | 文本说明 |
| created_at/updated_at | timestamp | 时间 |

### 建议的 remark 枚举（示例）
- direct_bonus
- level_pair_bonus
- pair_bonus
- matching_bonus
- stockist_dividend
- leader_dividend
- pending_bonus_release
- reversal_direct_bonus
- reversal_level_pair_bonus
- adjustment_reversal

### V10.1 审计增强（建议，配合“调整批次/冲正关联”已拍板）
为做到“可追溯 + 幂等 + 可对账”，建议在 transactions 采用其一：
- 方案 A：在 transactions 增加字段
  - source_type/source_id（order/weekly_settlement/quarterly_settlement/adjustment）
  - reversal_of_id（被冲正的原交易 transactions.id）
  - adjustment_batch_id（调整批次）
- 方案 B：保持 transactions 不变，新增 adjustment_entries 作为关联表（见 2.11）。

## 1.7 general_settings（全局配置：现有）
现有字段包含：bv_price/total_bv/max_bv/cary_flash/matching_bonus_time 等。

### V10.1 建议
- 不直接复用旧 matching 参数作为 V10.1 奖金制度（避免混淆）。
- 建议新增：bonus_config_json（JSON）或新增独立表 bonus_configs（按版本管理）。

## 1.8 withdrawals（提现申请：现有）
来源：`Files/install/database.sql`。

| 字段 | 类型 | 说明 |
|---|---|---|
| id | bigint unsigned | 主键 |
| form_id | int | 表单 ID（现有） |
| method_id | int unsigned | 提现方式 |
| user_id | int unsigned | 用户 |
| amount | decimal(28,8) | 申请金额 |
| currency | varchar(40) | 币种 |
| rate | decimal(28,8) | 汇率 |
| charge | decimal(28,8) | 手续费 |
| trx | varchar(40) | 提现流水号 |
| final_amount | decimal(28,8) | 最终到账（现有含义） |
| after_charge | decimal(28,8) | 扣费后金额（现有含义） |
| withdraw_information | text | 提现信息 |
| status | tinyint(1) | 1=success, 2=pending, 3=cancel（现有注释） |
| admin_feedback | text | 后台反馈 |
| created_at/updated_at | timestamp | 时间 |

> V10.1 规则落地：当用户 balance < 0（负余额）时，禁止发起新的提现申请（业务逻辑限制，避免坏账扩大）。

## 2. V10.1 建议新增表（满足“可追溯/可复算/可审核”）

## 2.1 user_level_hits（层碰点亮记录）
用途：按“用户 + 层级”记录左右点亮状态，确保每层只发一次。

| 字段 | 类型 | 说明 |
|---|---|---|
| id | bigint pk | 主键 |
| user_id | bigint | 被触发的上级用户 |
| level | int | 相对层级（1,2,3...） |
| left_hit_by | bigint null | 左侧首次点亮来源用户/订单（选一） |
| right_hit_by | bigint null | 右侧首次点亮来源用户/订单（选一） |
| status | tinyint | 0=未发，1=已发 |
| created_at/updated_at | timestamp | 时间 |

索引：UNIQUE(user_id, level)

## 2.2 weekly_settlements（周结算批次表）
| 字段 | 类型 | 说明 |
|---|---|---|
| id | bigint pk | 主键 |
| week_key | varchar(20) | 例如 2025-W50 |
| start_date | date | 周起 |
| end_date | date | 周止 |
| total_pv | decimal(20,2) | 当周全网新增 PV |
| fixed_sales | decimal(20,2) | 当周直推+层碰（已发 + 待处理应计预留） |
| global_reserve | decimal(20,2) | 当周 4% 预留 |
| variable_potential | decimal(20,2) | A：对碰封顶后理论 + 管理理论（均未乘 K） |
| k_factor | decimal(8,4) | K 值 |
| status | tinyint | 0=dry_run，1=finalized |
| config_version_code | varchar(20) | 制度版本（例如 V10.1） |
| config_snapshot | json null | 规则快照（比例/封顶/周定义/K精度等） |
| finalized_by | bigint null | 执行人（管理员） |
| finalized_at | timestamp null | 执行时间 |
| created_at/updated_at | timestamp | 时间 |

索引建议：
- UNIQUE(week_key)

## 2.3 weekly_settlement_user_summaries（周结算-用户汇总）
| 字段 | 类型 | 说明 |
|---|---|---|
| id | bigint pk | 主键 |
| settlement_id | bigint | 对应 weekly_settlements.id |
| user_id | bigint | 用户 |
| left_pv_open | decimal(16,8) | 左区 PV 期初 |
| right_pv_open | decimal(16,8) | 右区 PV 期初 |
| left_pv_close | decimal(16,8) | 左区 PV 期末 |
| right_pv_close | decimal(16,8) | 右区 PV 期末 |
| pair_count | int | 对碰次数 |
| pair_potential | decimal(20,2) | 对碰理论 |
| pair_paid | decimal(20,2) | 对碰实发 |
| matching_potential | decimal(20,2) | 管理理论 |
| matching_paid | decimal(20,2) | 管理实发 |
| cap_amount | decimal(20,2) | 对碰周封顶额度 |
| cap_used | decimal(20,2) | 对碰已使用封顶金额（对碰实发累计） |
| k_factor | decimal(8,4) | 本周 K 值（便于导出单表对账） |
| created_at/updated_at | timestamp | 时间 |

索引建议：
- UNIQUE(settlement_id, user_id)

## 2.4 pending_bonuses（待处理奖金台账）
用途：直推/层碰/管理等在“收款人未激活”时先记录，后续**自动释放+异常人工**；并支持“应计预留”纳入当周 FixedSales。

索引/幂等键建议：
- UNIQUE(user_id, bonus_type, source_type, source_id)
  - 用途：同一订单/批次产生的同类待处理奖金不重复入账（幂等）。

| 字段 | 类型 | 说明 |
|---|---|---|
| id | bigint pk | 主键 |
| user_id | bigint | 收款人 |
| bonus_type | varchar(30) | direct/level_pair/matching 等 |
| amount | decimal(20,2) | 金额 |
| source_type | varchar(30) | order/settlement 等 |
| source_id | varchar(50) | 统一口径：source_type=order 时=orders.trx；source_type=settlement 时=week_key/quarter_key；source_type=adjustment 时=batch_key |
| accrued_week_key | varchar(20) | 应计归属周（用于 FixedSales 统计，避免释放时重复计入） |
| status | tinyint | 0=pending，1=released，2=rejected，3=frozen |
| release_mode | varchar(20) | auto/manual（自动释放或人工释放） |
| released_trx | varchar(40) null | 释放时生成的交易流水号 |
| reviewed_by | bigint null | 审核人 |
| reviewed_at | timestamp null | 审核时间 |
| remark | varchar(255) null | 审核原因 |
| created_at/updated_at | timestamp | 时间 |

## 2.5 quarterly_settlements（季度分红批次）
| 字段 | 类型 | 说明 |
|---|---|---|
| id | bigint pk | 主键 |
| quarter_key | varchar(10) | 例如 2025-Q4 |
| start_date | date | 区间起 |
| end_date | date | 区间止 |
| pay_date | date null | 发放日（例如 1/4/7/10 月 15 日） |
| total_pv | decimal(20,2) | 当季全网新增 PV |
| pool_stockist | decimal(20,2) | 1% 池 |
| pool_leader | decimal(20,2) | 3% 池 |
| total_shares | decimal(20,4) | Eligible 且 Active 的 Shares 总和 |
| unit_value_stockist | decimal(28,8) | 1% 单份价值 |
| total_score | decimal(20,4) | 3% 总积分 Score 总和 |
| unit_value_leader | decimal(28,8) | 3% 单积分价值 |
| status | tinyint | 0=dry_run，1=finalized |
| config_version_code | varchar(20) | 制度版本（例如 V10.1） |
| config_snapshot | json null | 规则快照（门槛/系数/活跃口径等） |
| finalized_by | bigint null | 执行人（管理员） |
| finalized_at | timestamp null | 执行时间 |
| created_at/updated_at | timestamp | 时间 |

索引建议：
- UNIQUE(quarter_key)

## 2.6 dividend_logs（分红明细）
可拆成 stockist_dividend_logs / leader_dividend_logs，也可合并。

建议字段：
- settlement_id（季度）
- user_id
- dividend_type（stockist/leader）
- shares_or_score
- amount
- status（paid/skipped，当季未达标/未活跃不发）
- snapshot（JSON：关键计算快照）

## 2.7 user_assets（莲子资产表）
依据 Web3 方案。

| 字段 | 类型 | 说明 |
|---|---|---|
| user_id | bigint pk | 用户 |
| lotus_points | decimal(20,4) | 莲子余额 |
| total_mined | decimal(20,4) | 累计产出 |
| hash_rate | decimal(10,2) | 算力系数（默认 1.0） |

## 2.8 user_points_log（莲子流水表）
| 字段 | 类型 | 说明 |
|---|---|---|
| id | bigint pk | 主键 |
| user_id | bigint | 用户 |
| amount | decimal(20,4) | 变更值（允许为负，用于冲正） |
| source_type | varchar(20) | PURCHASE/DIRECT/TEAM/DAILY |
| reference_id | varchar(50) | 统一口径：PURCHASE/DIRECT=orders.trx；TEAM=weekly_settlements.week_key；DAILY=YYYY-MM-DD |
| reversal_of_id | bigint null | 被冲正的原流水 user_points_log.id（可选，但强烈建议） |
| adjustment_batch_id | bigint null | 调整批次（Finalize 后退款/纠错场景） |
| created_at | timestamp | 时间 |

索引/幂等键建议：
- INDEX(user_id, created_at)
- INDEX(reversal_of_id)
- INDEX(adjustment_batch_id)
- UNIQUE(user_id, source_type, reference_id)（用于防止 DAILY 重复签到；也能防止同一订单重复发积分）
- UNIQUE(reversal_of_id)
  - 用途：同一条积分流水只允许冲正一次（幂等，适用于“整单退款”口径）。

## 2.9 user_points_snapshot（莲子快照 Hash，可选）
| 字段 | 类型 | 说明 |
|---|---|---|
| id | bigint pk | 主键 |
| snapshot_date | date | 日期 |
| total_points | decimal(20,4) | 全网总莲子（可选） |
| snapshot_hash | varchar(128) | Hash/签名 |
| created_at | timestamp | 时间 |

## 2.10 adjustment_batches（调整批次，已拍板）
用途：用于“周结 Finalize 后发生退款”或其他需要差额修正的场景；把一次调整的所有影响汇总为可审计批次。

| 字段 | 类型 | 说明 |
|---|---|---|
| id | bigint pk | 主键 |
| batch_key | varchar(40) | 批次号，例如 ADJ-2025-W50-0001 |
| reason_type | varchar(40) | refund_before_finalize / refund_after_finalize / manual_correction |
| reference_type | varchar(30) | order/withdrawal/settlement |
| reference_id | varchar(50) | 订单号/流水号/批次号（若为订单退款：reference_id=orders.trx） |
| related_week_key | varchar(20) null | 关联周结 week_key（如适用） |
| status | tinyint | 0=draft，1=finalized，2=void |
| created_by | bigint | 操作管理员 |
| finalized_by | bigint null | 执行管理员 |
| note | varchar(255) null | 备注 |
| snapshot | json null | 调整计算快照（建议保留：影响用户列表摘要/规则版本/关键输入） |
| created_at/updated_at | timestamp | 时间 |

索引/幂等键建议：
- UNIQUE(batch_key)
- UNIQUE(reason_type, reference_type, reference_id)
  - 用途：避免同一笔订单退款/同一纠错原因重复生成多个调整批次（幂等）。
- INDEX(reference_type, reference_id)
- INDEX(related_week_key)

## 2.11 adjustment_entries（调整明细/冲正关联，已拍板）
用途：记录一个调整批次下的每条差额，并把“本次生成的记录”与“被冲正的原记录”关联起来。

| 字段 | 类型 | 说明 |
|---|---|---|
| id | bigint pk | 主键 |
| batch_id | bigint | adjustment_batches.id |
| user_id | bigint | 影响用户 |
| ledger_type | varchar(20) | wallet/pv/points |
| amount | decimal(28,8) | 变更值（wallet/pv 用；points 也可统一用该精度） |
| remark | varchar(40) | 例如 reversal_direct_bonus / reversal_level_pair_bonus / points_reversal |
| created_table | varchar(40) | 本次生成记录所在表：transactions/user_points_log/bv_logs/pv_ledger |
| created_row_id | bigint null | 本次生成记录的 id |
| reversal_of_table | varchar(40) null | 被冲正来源表 |
| reversal_of_row_id | bigint null | 被冲正记录 id |
| created_at | timestamp | 时间 |

索引/幂等键建议：
- INDEX(batch_id)
- INDEX(user_id, ledger_type)
- UNIQUE(batch_id, ledger_type, reversal_of_table, reversal_of_row_id)
  - 用途：同一调整批次内，同一条来源记录只允许冲正一次（幂等）。

## 2.12 pv_ledger（PV 台账，已拍板）
> 已拍板：新增结构化 `pv_ledger`，用于“按订单批量回滚/冲正”与可对账复算；`bv_logs` 仅用于兼容历史。

### source_id 口径（写死）
- 当 `source_type=order`：`source_id = orders.trx`
- 当 `source_type=weekly_settlement`：`source_id = weekly_settlements.week_key`
- 当 `source_type=adjustment`：`source_id = adjustment_batches.batch_key`

| 字段 | 类型 | 说明 |
|---|---|---|
| id | bigint pk | 主键 |
| user_id | bigint | 被累计 PV 的上级用户 |
| from_user_id | bigint | PV 来源用户（下单者） |
| position | tinyint | 1=Left，2=Right（相对 user_id） |
| level | int | 相对层级（从 1 开始） |
| amount | decimal(16,8) | PV 变更值 |
| trx_type | varchar(2) | "+" 或 "-" |
| source_type | varchar(30) | order/weekly_settlement/adjustment |
| source_id | varchar(50) | 见上方“source_id 口径（写死）” |
| adjustment_batch_id | bigint null | 调整批次（发货后退款/纠错） |
| reversal_of_id | bigint null | 被冲正的 pv_ledger.id（建议：冲正行必须填写） |
| created_at | timestamp | 时间 |

索引/幂等键建议（强烈建议实现）：
- INDEX(user_id, created_at)
- INDEX(from_user_id, created_at)
- INDEX(source_type, source_id)
- INDEX(adjustment_batch_id)
- INDEX(reversal_of_id)
- UNIQUE(source_type, source_id, user_id, position, trx_type)
  - 用途：保证“订单发货 PV 入账 / 周结 PV 扣减 / 调整批次 PV 冲正”具备幂等性。

## 2.13 bonus_configs（制度版本配置，建议）
用途：把 V10.1 的比例/封顶/K/周定义/七宝门槛等参数按“版本”固化，避免改制度改代码。

| 字段 | 类型 | 说明 |
|---|---|---|
| id | bigint pk | 主键 |
| version_code | varchar(20) | 例如 V10.1 |
| config_json | json | 参数快照（比例、封顶、周起始、K 精度等） |
| is_active | tinyint | 0/1 |
| created_at/updated_at | timestamp | 时间 |

## 2.14 audit_logs（后台审计日志，建议）
用途：手工释放待处理奖金、执行调整批次、手工修正 PV/积分等必须写入审计。

| 字段 | 类型 | 说明 |
|---|---|---|
| id | bigint pk | 主键 |
| admin_id | bigint | 操作人 |
| action_type | varchar(40) | release_pending/adjustment_finalize/manual_fix 等 |
| object_type | varchar(40) | pending_bonuses/adjustment_batches/pv_ledger 等 |
| object_id | varchar(50) | 关联对象 |
| before_json | json null | 变更前快照（可选） |
| after_json | json null | 变更后快照（可选） |
| reason | varchar(255) | 原因 |
| created_at | timestamp | 时间 |

## 3. 已拍板的落库选择（2025-12-16 更新）
1) PV 台账：新建 `pv_ledger`（见 2.12）。
2) 待处理奖金：需要“应计预留”并纳入当周 FixedSales。
3) TEAM 莲子：按周结产出（随周结批次一次性产出）。
4) 退款冲正与调整批次：新增 `adjustment_batches` + `adjustment_entries`，并在钱包/积分/PV 台账中保留 reversal_of 关联。

## 4. 需求点 → 表/字段映射清单（V10.1）
> 目的：把《用户端需求》《后台需求》《结算与对账需求》《总览 URD》的关键需求点，逐条映射到可落库/可对账的表与字段。

### 4.1 用户、关系与等级
- Sponsor（推荐关系）
  - `users.ref_by`
- Placement（二元安置关系）
  - `users.pos_id`（上级）
  - `users.position`（1=Left，2=Right）
- 激活口径（个人累计请购 ≥ 1 台）
  - `users.personal_purchase_count`（建议：订单发货入账时累加）
  - `users.rank_level`（建议：由 personal_purchase_count 驱动自动升级）
  - 来源订单：`orders.status=shipped` + `orders.quantity`
- 季度活跃判定（当季直推 1 单或自购 1 单）
  - `users.last_activity_date`（订单发货时更新）

### 4.2 商品、订单与 PV 入账（发货触发）
- 商品价格/PV
  - `products.price`
  - `products.bv`（V10.1 作为 PV）
- 订单与发货节点
  - `orders.status`（pending/shipped/canceled）
  - `orders.trx`（订单交易号，已写死为 V10.1 订单型台账的统一 reference_id/source_id）
  - `orders.quantity`、`orders.total_price`
- PV 左右区累计展示
  - `user_extras.bv_left` / `user_extras.bv_right`（展示为 PV 左/右）
- PV 台账（已拍板：`pv_ledger`，可追溯/可冲正）
  - `pv_ledger`（见 2.12，支持按订单回滚与 reversal_of 关联）
  - `bv_logs`：仅用于兼容历史（不作为 V10.1 主台账）

### 4.3 直推奖（实时）
- 已激活收款人：直接入钱包流水
  - `transactions`（`remark=direct_bonus`，`trx_type=+`，`details` 记录订单）
- 未激活收款人：进入待处理 + 应计预留
  - `pending_bonuses`（`bonus_type=direct`，`status=pending`，`source_type=order`，`source_id=orders.trx`，`accrued_week_key`）
- 待处理释放（激活后自动释放/异常人工）
  - `pending_bonuses.status/release_mode/released_trx`
  - `transactions`（`remark=pending_bonus_release`，`trx_type=+`）
  - `audit_logs`（建议：`action_type=release_pending`）

### 4.4 层碰奖（实时）
- 点亮与“一层只发一次”的控制
  - `user_level_hits`（`UNIQUE(user_id, level)`）
  - `user_level_hits.left_hit_by/right_hit_by`（建议记录订单/用户来源）
- 已激活收款人入账
  - `transactions`（`remark=level_pair_bonus`）
- 未激活收款人待处理
  - `pending_bonuses`（`bonus_type=level_pair`，`source_type=order`，`source_id=orders.trx`，`accrued_week_key`）

### 4.5 周结算（对碰 + 管理 + 周封顶 + K 值 + PV 扣减）
- 周结批次主表
  - `weekly_settlements`（`week_key/start_date/end_date`、`fixed_sales/global_reserve/variable_potential/k_factor`、`config_snapshot`、`finalized_by/finalized_at`）
- 用户周结汇总（用于导出/对账）
  - `weekly_settlement_user_summaries`（`left_pv_open/right_pv_open/left_pv_close/right_pv_close`、`pair_*`、`matching_*`、`cap_*`、`k_factor`）
- 对碰/管理入账流水
  - `transactions`（`remark=pair_bonus`、`remark=matching_bonus`，建议 details/remark 含 week_key）
- PV 扣减日志（仅扣减已发放部分）
  - `pv_ledger`（`trx_type=-`，`source_type=weekly_settlement`，`source_id=week_key`）
  - `bv_logs`：仅历史兼容（不作为 V10.1 扣减主台账）

### 4.6 季度分红（1% 消费商池 + 3% 领导人池）
- 季度批次
  - `quarterly_settlements`（`quarter_key/start_date/end_date/pay_date`、`pool_*`、`total_shares/unit_value_stockist`、`total_score/unit_value_leader`、`config_snapshot`）
- 分红明细
  - `dividend_logs`（建议拆分或合并，含 `snapshot` 快照）
- 分红入账
  - `transactions`（`remark=stockist_dividend` / `remark=leader_dividend`）
- 领导人职级/W 系数
  - `users.leader_rank_code` / `users.leader_rank_multiplier`（季度结算时建议固化到 dividend_logs.snapshot）

### 4.7 七宝进阶/职级体系（用于 3% 领导人池）
- 当前职级与系数展示/计算
  - `users.leader_rank_code` / `users.leader_rank_multiplier`
- 历史累计小区 PV（Small Leg）
  - 来源建议：`pv_ledger`（可复算），或落一张 user_rank_snapshots（可选增强，未单独建表）

### 4.8 莲子积分（A/B/C/D）与快照
- 资产与流水
  - `user_assets`（余额/累计产出/算力系数）
  - `user_points_log`（`source_type=PURCHASE/DIRECT/TEAM/DAILY`，`reference_id` 写死口径：PURCHASE/DIRECT=orders.trx；TEAM=week_key；DAILY=YYYY-MM-DD）
- 防重复/幂等
  - 建议：`UNIQUE(user_id, source_type, reference_id)`（尤其 DAILY 签到、订单积分）
- 冲正与调整批次
  - `user_points_log.amount` 允许为负
  - `user_points_log.reversal_of_id`（被冲正原流水）
  - `user_points_log.adjustment_batch_id`（Finalize 后退款走调整批次）
- 快照 Hash（可选）
  - `user_points_snapshot`

### 4.9 退款/退单（已发奖金）冲正、负余额与提现限制
- 退款事件记录（落库口径）
  - 发货后退款：统一生成一条 `adjustment_batches` 记录，`reference_type=order`，`reference_id=orders.trx`。
  - 若退款发生在周结 Finalize 之前：可由系统自动创建并自动 finalized（reason_type=refund_before_finalize）。
  - 若退款发生在周结 Finalize 之后：进入人工流程创建/确认并 finalized（reason_type=refund_after_finalize）。
- 冲正记录（幂等）
  - 钱包：生成负向 `transactions`（建议通过 `adjustment_entries` 关联到被冲正来源流水）。
  - PV：生成负向 `pv_ledger`，并填写 `reversal_of_id` + `adjustment_batch_id`。
  - 莲子：生成负向 `user_points_log`，并填写 `reversal_of_id` + `adjustment_batch_id`。
- 负余额与提现限制（已拍板）
  - `users.balance` 允许为负。
  - `withdrawals`：业务逻辑限制（balance < 0 禁止新提现）。

### 4.10 后台审核、风控与审计
- 待处理奖金审核/释放
  - `pending_bonuses`（状态流转）
  - `audit_logs`（建议记录 release/freeze/reject）
- 调整批次执行审计
  - `adjustment_batches.created_by/finalized_by` + `snapshot`
  - `audit_logs`（建议：`action_type=adjustment_finalize`）

### 4.11 报表与对账导出（最小闭环）
- 资金对账
  - `transactions`（按 remark/week_key/quarter_key/adjustment_batch 归集）
- PV 对账
  - `pv_ledger` + `user_extras`
  - `bv_logs`：仅历史兼容（可选对账辅助）
- 结算批次对账
  - `weekly_settlements` + `weekly_settlement_user_summaries`
  - `quarterly_settlements` + `dividend_logs`
- 莲子对账
  - `user_assets` + `user_points_log` + `user_points_snapshot`（可选）

### 4.12 后台参数中心/制度版本（建议）
- 制度参数（比例/封顶/K/周定义/七宝门槛等）版本化
  - `bonus_configs`（推荐：version_code + config_json）
- 每次周结/季结固化本次使用的规则快照（用于追溯）
  - `weekly_settlements.config_version_code/config_snapshot`
  - `quarterly_settlements.config_version_code/config_snapshot`

### 4.13 异常与工单（后台）（已定）
- 用户侧客服工单：复用现有工单体系（不新建表，降低成本）
  - `support_tickets`、`support_messages`、`support_attachments`
- 内部财务/风控/结算异常工单（含 Finalize 后退款/纠错）：统一走“调整批次”可审计闭环（不复用 support_tickets，避免用户侧混入内部工单）
  - `adjustment_batches` + `adjustment_entries` + `audit_logs`

> 说明：PV 台账已拍板采用 `pv_ledger`；`bv_logs` 仅用于兼容历史。
